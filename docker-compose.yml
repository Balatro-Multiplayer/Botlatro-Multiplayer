version: "3.9"

services:
  db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: nkqueue
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d nkqueue || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20

  seed-settings:
    image: postgres:16
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGPASSWORD: postgres
    restart: "no"
    command: >
      bash -lc "
      psql -h db -U postgres -d nkqueue -v ON_ERROR_STOP=1 -c
      \"insert into settings
         (singleton, queue_category_id, helper_role_id, decay_threshold, decay_amount, decay_interval, decay_grace, match_count_channel_id)
       select true,
              ''::varchar,            -- queue_category_id
              ''::varchar,            -- helper_role_id
              1000,                   -- decay_threshold
              25,                     -- decay_amount
              24,                     -- decay_interval
              6,                      -- decay_grace
              ''::text                -- match_count_channel_id
       where not exists (select 1 from settings where singleton = true);\""

  bot:
    build: .
    environment:
      DATABASE_URL: postgres://postgres:postgres@db:5432/nkqueue
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      CLIENT_ID: ${CLIENT_ID}
      GUILD_ID: ${GUILD_ID}
    depends_on:
      db:
        condition: service_healthy
      seed-settings:
        condition: service_completed_successfully
    restart: unless-stopped

volumes:
  pgdata: {}
